{% extends "base.html" %}

{% block meta %}
<script src="/static/js/passfield.min.js"></script>
<script src="/static/js/change_password.js"></script>
<script src="/static/js/nic.js"></script>
<script src="/static/js/contracts.js"></script>
<link rel="stylesheet" href="/static/css/passfield.min.css"/>
{% endblock %}

{% block content %}
<div id="breadcrumbs" class="breadcrumb">
    <a href="/">Inicio</a> &raquo; <strong>Perfil de Usuario</strong>
</div>

<form class="form-horizontal" method="post">
{% csrf_token %}
<div class="modal hide fade" id="passwordForm">
    <div class="modal-header">Cambio de Clave</div>
    <div class="modal-body">
        <div class="control-group{% if form.old_password.errors %} error{% endif %}">
            <label class="control-label" for="id_old_password">Contraseña antigua</label>
            <div class="controls">
                {{ form.old_password }}
                {% for error in form.old_password.errors %}
                <span class="help-inline">{{ error }}</span>
                {% endfor %}
            </div>
        </div>
        <div class="control-group{% if form.new_password1.errors %} error{% endif %}">
            <label class="control-label" for="id_new_password1">Contraseña nueva</label>
            <div class="controls">
                {{ form.new_password1 }}
                {% for error in form.new_password1.errors %}
                <span class="help-inline">{{ error }}</span>
                {% endfor %}
            </div>
        </div>
        <div class="control-group{% if form.new_password2.errors %} error{% endif %}">
            <label class="control-label" for="id_new_password2">Confirmación</label>
            <div class="controls">
                {{ form.new_password2 }}
                {% for error in form.new_password2.errors %}
                <span class="help-inline">{{ error }}</span>
                {% endfor %}
            </div>
        </div>
    </div>
    <input type="hidden" name="form" value="password"/>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Cancela</a>
        <button type="submit" class="btn btn-primary">Cambia clave</a>
    </div>
</div>
</form>

{% if form.old_password.errors or form.new_password1.errors or form.new_password2.errors %}
<script type="text/javascript"><!--

$('#passwordForm').modal('show');

// --></script>
{% endif %}

<ul class="nav nav-tabs">
    <li{% if not nic_focus and not contract_focus %} class="active"{% endif %}>
        <a href="#info-user" data-toggle="tab">Usuario</a>
    </li>
    <li>
        <a href="#info-dynhost" data-toggle="tab">DynHOST</a>
    </li>
    <li{% if nic_focus %} class="active"{% endif %}>
        <a href="#info-client" data-toggle="tab">Cliente</a>
    </li>
    <li>
        <a href="#info-services" data-toggle="tab">Servicios</a>
    </li>
    <li{% if contract_focus %} class="active"{% endif %}>
        <a href="#info-contracts" data-toggle="tab">Contratos</a>
    </li>
</ul>
<div id="profile-tab-content" class="tab-content">
    <div class="tab-pane fade{% if not nic_focus and not contract_focus %} in active{% endif %}" id="info-user">
        <h1>Información del Usuario</h1>
        <table class="table table-condensed">
            <tr><th>Usuario</th><td>{{ cuenta.user.username }}</td></tr>
            <tr><th>eMail</th><td>{{ cuenta.user.email }}</td></tr>
            <tr><th>Alta</th><td>{{ cuenta.user.date_joined|date:"d/m/Y" }}</td></tr>
            <tr><th>Cuota Mensual</th><td>{{ currency }} {{ paymonth|floatformat:2|default:"0.00" }}</td></tr>
        </table>
        <br />
        <div class="pull-right">
            <a href="#passwordForm" class="btn btn-danger" data-toggle="modal">
                <i class="icon-lock icon-white"></i>
                Cambia Clave
            </a>
        </div>
    </div>
    <div class="tab-pane fade{% if nic_focus %} in active{% endif %}" id="info-client">
        <h1>Información de Cliente</h1>

        <div class="row-fluid">
            <div class="offset2 span8">
                <p><strong>IMPORTANTE</strong>: estos datos son obligatorios si desea darse de alta como cliente para contratar un servicio (dominios, redirecciones de email, redirecciones web, etc.) En caso de rellenar este apartado acepta las <a href="">Condiciones del Servicio para Clientes</a>.</p>

                <form class="form-horizontal" method="post">
                    {% csrf_token %}
                    {% for field in nic_form %}
                    <div id="nic_form_{{ field.html_name }}" class="control-group{% if field.errors %} error{% endif %}">
                        <label class="control-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                        <div class="controls">
                            {{ field }}
                            {% for error in field.errors %}
                            <span class="help-inline">{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}

                    <input type="hidden" name="form" value="nic"/>

                    <div class="control-group">
                        <div class="controls">
                            <button type="submit" class="btn btn-primary">{% if not nic_new %}Modificar{% else %}Dar de Alta{% endif %}</button>
                        </div>
                    </div>

                </form>

            </div>
        </div>

    </div>
    <div class="tab-pane fade" id="info-dynhost">
        <h1>Información de Servicios DynHost</h1>
        <table class="table table-condensed">
        <thead>
            <th colspan="2">Servicio</th>
            <th>Usados</th>
            <th>Total</th>
        </thead>
        <tbody>
            <tr>
                <td><img src="/static/img/32/earth.png" /></td>
                <td>DynHosts</td>
                <td align="right">{{ dynhosts }}&nbsp;</td>
                <td align="right">{{ cuenta.limit_dynhost }}&nbsp;</td>
            </tr>
            <tr>
                <td><img src="/static/img/32/redirect.png" /></td>
                <td>Redirecciones</td>
                <td align="right">{{ redirects_mail_dynhost }}&nbsp;</td>
                <td align="right">{{ cuenta.limit_email_redirect }}&nbsp;</td>
            </tr>
            <tr>
                <td><img src="/static/img/32/redirect_web.png" /></td>
                <td>Redirecciones Web</td>
                <td align="right">{{ redirects_web_dynhost }}&nbsp;</td>
                <td align="right">{{ cuenta.limit_web_redirect }}&nbsp;</td>
            </tr>
        </tbody>
        </table>
    </div>
    <div class="tab-pane fade" id="info-services">
        <h1>Información de Servicios</h1>
        <table class="table table-condensed">
        <thead>
            <th colspan="2">Servicio</th>
            <th>Usados</th>
            <th>Total</th>
        </thead>
        <tbody>
            <tr>
                <td><img src="/static/img/32/earth.png" /></td>
                <td>Dominios</td>
                <td align="right">{{ dominios }}&nbsp;</td>
                <td align="right">{{ cuenta.limit_dns }}&nbsp;</td>
            </tr>
            <tr>
                <td><img src="/static/img/32/redirect.png" /></td>
                <td>Redirecciones</td>
                <td align="right">{{ redirects }}&nbsp;</td>
                <td align="right">{{ cuenta.limit_email_redirect }}&nbsp;</td>
            </tr>
            <tr>
                <td><img src="/static/img/32/mail.png" /></td>
                <td>Buzones de Correo</td>
                <td align="right">{{ mailboxes }}&nbsp;</td>
                <td align="right">{{ cuenta.limit_email_mailbox }}&nbsp;</td>
            </tr>
            <tr>
                <td><img src="/static/img/32/datebase.png" /></td>
                <td>Bases de Datos</td>
                <td align="right">{{ databases }}&nbsp;</td>
                <td align="right">{{ cuenta.limit_sql }}&nbsp;</td>
            </tr>
            <tr>
                <td><img src="/static/img/32/db_users.png" /></td>
                <td>Usuarios de Base de Datos</td>
                <td align="right">{{ dbusers }}&nbsp;</td>
                <td align="right">{{ cuenta.limit_sql_users }}&nbsp;</td>
            </tr>
            <tr>
                <td><img src="/static/img/32/redirect_web.png" /></td>
                <td>Redirecciones Web</td>
                <td align="right">{{ redirects_web }}&nbsp;</td>
                <td align="right">{{ cuenta.limit_web_redirect }}&nbsp;</td>
            </tr>
            <tr>
                <td><img src="/static/img/32/computer.png" /></td>
                <td>Hostings Web</td>
                <td align="right">{{ hosting }}&nbsp;</td>
                <td align="right">{{ cuenta.limit_web }}&nbsp;</td>
            </tr>
            <tr>
                <td><img src="/static/img/32/download.png" /></td>
                <td>Accesos FTP</td>
                <td align="right">{{ ftp }}&nbsp;</td>
                <td align="right">{{ cuenta.limit_ftp }}&nbsp;</td>
            </tr>
        </tbody>
        </table>
    </div>
    <div class="tab-pane fade{% if contract_focus %} in active{% endif %}" id="info-contracts">
        <h1>Información de Contratos</h1>
        <table class="table table-condensed">
        <thead>
            <th colspan="2">Tipo</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Descuento</th>
            <th>Total</th>
            <th>Expiración</th>
            <th>Opciones</th>
        </thead>
        <tbody>
            {% for contract in contracts %}
            <tr>
                <td>{% if contract.type == 'D' %}
                        <img src="/static/img/32/earth.png" />
                    {% elif contract.type == 'R' %}
                        <img src="/static/img/32/redirect.png" />
                    {% elif contract.type == 'm' or contract.type == 'M' %}
                        <img src="/static/img/32/mail.png" />
                    {% elif contract.type == 'B' %}
                        <img src="/static/img/32/datebase.png" />
                    {% endif %}
                </td>
                <td>{% if contract.type == 'D' %}
                        Dominios
                    {% elif contract.type == 'R' %}
                        Redirecciones de Email
                    {% elif contract.type == 'm' %}
                        Buzones de Email Plus
                    {% elif contract.type == 'M' %}
                        Buzones de Email Premium
                    {% elif contract.type == 'B' %}
                        Base de Datos MySQL
                    {% endif %}</td>
                <td align="right">{{ contract.quantity }}&nbsp;</td>
                <td align="right">{{ contract.price }}&nbsp;</td>
                <td align="right">{{ contract.discount }}&nbsp;</td>
                <td align="right">{{ contract.total }}&nbsp;</td>
                <td align="center">{{ contract.ends|date:"Y-m-d"|default:"---" }}&nbsp;</td>
                <td align="center">
                    {% if not contract.paid %}
                    <a href="{% url "billing.views.payment" contract.id %}" class="btn btn-success btn-small">Pagar</a>
                    {% if contract.type != 'D' %}
                    <a href="{% url "billing.views.revoke" contract.id %}" class="btn btn-danger btn-small">Cancelar</a>
                    {% else %}
                    <a id="eliminar_{{contract.id}}" href="#" data-toggle="popover" data-placement="left" data-content="No se puede eliminar este contrato. El dominio debe darse de baja en la sección de dominios." data-origintal-title="Eliminar" class="btn btn-danger btn-small">Eliminar</a>
                    {% endif %}
                    {% else %}
                    <a href="{% url "billing.views.payment" contract.id %}" class="btn btn-success btn-small">Renovar</a>
                    {% if contract.type == 'R' and cuenta.can_remove_mail_redirect %}
                    <a href="{% url "billing.views.revoke" contract.id %}" class="btn btn-danger btn-small">Eliminar</a>
                    {% elif contract.type == 'm' and cuenta.can_remove_mail_plus %}
                    <a href="{% url "billing.views.revoke" contract.id %}" class="btn btn-danger btn-small">Eliminar</a>
                    {% elif contract.type == 'M' and cuenta.can_remove_mail_premium %}
                    <a href="{% url "billing.views.revoke" contract.id %}" class="btn btn-danger btn-small">Eliminar</a>
                    {% elif contract.type == 'B' and cuenta.can_remove_mysql_database %}
                    <a href="{% url "billing.views.revoke" contract.id %}" class="btn btn-danger btn-small">Eliminar</a>
                    {% elif contract.type != 'D' %}
                    <a id="eliminar_{{contract.id}}" href="#" data-toggle="popover" data-placement="left" data-content="No se puede eliminar el contrato porque está en uso. Elimine antes el recurso en uso." data-origintal-title="Eliminar" class="btn btn-danger btn-small">Eliminar</a>
                    {% else %}
                    <a id="eliminar_{{contract.id}}" href="#" data-toggle="popover" data-placement="left" data-content="No se puede eliminar este contrato. El dominio debe darse de baja en la sección de dominios." data-origintal-title="Eliminar" class="btn btn-danger btn-small">Eliminar</a>
                    {% endif %}
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8">No hay contratos</td>
            </tr>
            {% endfor %}
        </tbody>
        </table>
        <br />
        <div class="pull-right">
            <a href="/" class="btn btn-success">
                <i class="icon-money icon-white"></i>
                Contratar
            </a>
        </div>
    </div>
</div>
{% endblock %}
